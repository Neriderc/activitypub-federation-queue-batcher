---
- name: Install packages
  ansible.builtin.apt:
    name:
      - nginx
      - ca-certificates
      - certbot
      - python3-certbot-nginx
    cache_valid_time: 86400

- name: Request initial letsencrypt certificate
  ansible.builtin.command:
    argv:
      - certbot
      - certonly
      - --nginx
      - --agree-tos
      - --cert-name
      - "{{ domain }}"
      - -d
      - "{{ domain }}"
      - --register-unsafely-without-email
  args:
    creates: "/etc/letsencrypt/live/{{ domain }}/privkey.pem"

- name: Distribute nginx configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
    validate: nginx -c %s -t
  diff: true
  notify: Reload nginx.service

- name: Certbot renewal cronjob
  ansible.builtin.cron:
    special_time: daily
    name: certbot-renew
    user: root
    job: "certbot certonly --nginx --cert-name '{{ domain }}' -d '{{ domain }}' --deploy-hook 'systemctl reload nginx.service'"
